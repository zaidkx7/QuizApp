{% extends "admin/layout.html" %}

{% block title %}Manage Users - Quiz App{% endblock %}
{% block header_title %}Manage Students{% endblock %}

{% block content %}

{% if message %}
<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 shadow-sm rounded-r" role="alert">
    <p>{{ message }}</p>
</div>
{% endif %}

<!-- Add New User Card -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 mb-8">
    <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
        <i class="fas fa-user-plus mr-2 text-purple-600"></i> Add New Student
    </h2>
    <form method="POST" action="/admin/users/add" class="grid md:grid-cols-4 gap-4 items-end">
        <div>
            <label for="user_id" class="block text-sm font-medium text-slate-700 mb-1">Student ID</label>
            <input type="text" id="user_id" name="user_id" required placeholder="e.g. S101"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
        </div>
        <div>
            <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
            <input type="text" id="password" name="password" required placeholder="Hidden unless changed"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
        </div>
        <div>
            <label for="email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
            <input type="email" id="email" name="email" required placeholder="student@example.com"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
        </div>
        <div>
            <button type="submit"
                class="w-full bg-purple-600 text-white py-2.5 rounded-lg hover:bg-purple-700 transition font-semibold shadow-sm hover:shadow active:scale-95 flex items-center justify-center">
                <i class="fas fa-plus mr-2"></i> Add Student
            </button>
        </div>
    </form>
</div>

<!-- Users List -->
{% if users %}
<div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        Student Details
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        Credentials
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        Activity
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-100">
                {% for user in users %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div
                                class="h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 mr-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-900">{{ user.username }}</div>
                                <div class="text-sm text-slate-500">ID: {{ user.user_id }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-slate-900"><span class="font-medium">PWD:</span> {{ user.password }}
                        </div>
                        <div class="text-sm text-slate-500">{{ user.email if user.email else 'No email' }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ user.results|length }} submission(s)
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end gap-2">
                            <button
                                onclick="showEditModal('{{ user.id }}', '{{ user.user_id }}', '{{ user.password }}', '{{ user.email if user.email else '' }}')"
                                class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 p-2 rounded transition"
                                title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form method="POST" action="/admin/users/delete/{{ user.id }}" class="inline"
                                onsubmit="return confirm('Are you sure you want to delete this user and all their submissions?')">
                                <button type="submit"
                                    class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 p-2 rounded transition"
                                    title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-12 text-center">
    <div class="inline-block p-4 rounded-full bg-slate-50 mb-4">
        <i class="fas fa-users text-4xl text-slate-300"></i>
    </div>
    <h3 class="text-xl font-semibold text-slate-700 mb-2">No Students Yet</h3>
    <p class="text-slate-500">Add students using the form above.</p>
</div>
{% endif %}

<!-- Edit User Modal -->
<div id="editModal"
    class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all scale-100">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800">Edit Student</h3>
            <button onclick="hideEditModal()" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="editForm" method="POST" action="/admin/users/edit">
            <input type="hidden" id="edit_user_db_id" name="user_db_id">
            <div class="mb-4">
                <label for="edit_user_id" class="block text-sm font-medium text-slate-700 mb-1">Student ID</label>
                <input type="text" id="edit_user_id" name="user_id" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <label for="edit_password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                <input type="text" id="edit_password" name="password" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-6">
                <label for="edit_email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                <input type="email" id="edit_email" name="email" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="hideEditModal()"
                    class="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg hover:bg-slate-200 transition font-medium">
                    Cancel
                </button>
                <button type="submit"
                    class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition font-medium shadow-sm">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function showEditModal(userId, userIdValue, password, email) {
        document.getElementById('edit_user_db_id').value = userId;
        document.getElementById('edit_user_id').value = userIdValue;
        document.getElementById('edit_password').value = password;
        document.getElementById('edit_email').value = email;
        document.getElementById('editModal').classList.remove('hidden');
    }

    function hideEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    // Close modal on click outside
    document.getElementById('editModal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideEditModal();
        }
    });
</script>
{% endblock %}