{% extends "base.html" %}

{% block title %}Take Quiz - Quiz App{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-12">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">

        {% if attempt_number and attempt_number > 2 %}
        <!-- Retake Banner -->
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8 rounded-r-lg shadow-sm animate-pulse-slow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <p class="font-bold text-red-800">Final Attempt Warning</p>
                    <p class="text-sm text-red-700">This is your last attempt for this quiz. Please review your answers
                        carefully.</p>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Attempt Banner -->
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-8 rounded-r-lg shadow-sm animate-pulse-slow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-yellow-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <p class="font-bold text-yellow-800">Attempt Warning</p>
                    <p class="text-sm text-yellow-700">This is your attempt {{ attempt_number }} for this quiz. Please
                        review your answers
                        carefully.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between text-sm font-medium text-slate-500 mb-2">
                <span id="progressText">Question 1 of --</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
            </div>
        </div>

        <form method="POST" action="/user/submit/{{ quiz_id }}" id="quizForm" class="relative min-h-[400px]">
            <input type="hidden" name="attempt_id" value="{{ attempt_number }}">

            {% set step_counter = namespace(value=1) %}

            <!-- Questions Container -->
            <div id="questionsContainer">

                <!-- Fill in the Blanks -->
                {% if exam.fill_in_the_blanks %}
                {% for question in exam.fill_in_the_blanks %}
                <div class="question-step {% if not full_page_submission %}hidden{% endif %} mb-8"
                    data-step="{{ step_counter.value }}">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-purple-50 px-6 py-3 border-b border-purple-100 flex items-center">
                            <span class="text-xs font-bold text-purple-600 uppercase tracking-wider">Fill in the
                                Blank</span>
                        </div>
                        <div class="p-8">
                            <label class="block text-slate-900 font-bold text-xl mb-6 leading-relaxed">
                                {{ question.question }}
                            </label>
                            <input type="text" name="fib_{{ loop.index0 }}"
                                class="w-full px-5 py-4 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all placeholder-gray-400 text-slate-800 bg-slate-50 focus:bg-white text-lg"
                                placeholder="Type your answer here..." oninput="validateCurrentStep()">
                        </div>
                    </div>
                </div>
                {% set step_counter.value = step_counter.value + 1 %}
                {% endfor %}
                {% endif %}

                <!-- True/False -->
                {% if exam.true_false %}
                {% for question in exam.true_false %}
                <div class="question-step {% if not full_page_submission %}hidden{% endif %} mb-8"
                    data-step="{{ step_counter.value }}">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-blue-50 px-6 py-3 border-b border-blue-100 flex items-center">
                            <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">True or False</span>
                        </div>
                        <div class="p-8">
                            <p class="text-slate-900 font-bold text-xl mb-8 leading-relaxed">
                                {{ question.question }}
                            </p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <label class="relative cursor-pointer group">
                                    <input type="radio" name="tf_{{ loop.index0 }}" value="true" class="peer sr-only"
                                        onchange="validateCurrentStep()">
                                    <div
                                        class="p-5 rounded-xl border-2 border-slate-200 peer-checked:border-green-500 peer-checked:bg-green-50 hover:bg-slate-50 transition-all flex items-center justify-center gap-3">
                                        <i class="fas fa-check text-slate-300 peer-checked:text-green-600 text-xl"></i>
                                        <span
                                            class="font-bold text-slate-600 peer-checked:text-green-700 text-lg">True</span>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group">
                                    <input type="radio" name="tf_{{ loop.index0 }}" value="false" class="peer sr-only"
                                        onchange="validateCurrentStep()">
                                    <div
                                        class="p-5 rounded-xl border-2 border-slate-200 peer-checked:border-red-500 peer-checked:bg-red-50 hover:bg-slate-50 transition-all flex items-center justify-center gap-3">
                                        <i class="fas fa-times text-slate-300 peer-checked:text-red-600 text-xl"></i>
                                        <span
                                            class="font-bold text-slate-600 peer-checked:text-red-700 text-lg">False</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                {% set step_counter.value = step_counter.value + 1 %}
                {% endfor %}
                {% endif %}

                <!-- MCQs -->
                {% if exam.mcqs %}
                {% for question in exam.mcqs %}
                {% set question_index = loop.index0 %}
                <div class="question-step {% if not full_page_submission %}hidden{% endif %} mb-8"
                    data-step="{{ step_counter.value }}">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-orange-50 px-6 py-3 border-b border-orange-100 flex items-center">
                            <span class="text-xs font-bold text-orange-600 uppercase tracking-wider">Multiple
                                Choice</span>
                        </div>
                        <div class="p-8">
                            <p class="text-slate-900 font-bold text-xl mb-8 leading-relaxed">
                                {{ question.question }}
                            </p>
                            <div class="space-y-4">
                                {% for option in question.options %}
                                <label
                                    class="flex items-center p-5 border-2 border-slate-200 rounded-xl hover:bg-slate-50 cursor-pointer transition-all has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:shadow-sm">
                                    <input type="radio" name="mcq_{{ question_index }}" value="{{ option }}"
                                        class="w-6 h-6 text-blue-600 focus:ring-blue-500 border-gray-300"
                                        onchange="validateCurrentStep()">
                                    <span class="ml-4 text-slate-700 font-medium text-lg">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% set step_counter.value = step_counter.value + 1 %}
                {% endfor %}
                {% endif %}

            </div>

            <!-- Navigation Bar -->
            <div class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-4 z-50">
                <div class="max-w-3xl mx-auto flex items-center justify-between">
                    {% if not full_page_submission %}
                    <button type="button" id="prevBtn" onclick="changeStep(-1)"
                        class="px-6 py-2.5 rounded-lg font-bold text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> Previous
                    </button>

                    <button type="button" id="nextBtn" onclick="changeStep(1)"
                        class="px-8 py-2.5 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-blue-200">
                        Next <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    {% endif %}

                    <button type="submit" id="submitBtn"
                        class="{% if not full_page_submission %}hidden{% endif %} px-8 py-2.5 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700 transition-colors shadow-lg shadow-green-200 ml-auto">
                        Submit Quiz <i class="fas fa-check ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Padding for fixed footer -->
            <div class="h-24"></div>

        </form>
    </div>
</div>

<script>
    let currentStep = 0;
    const steps = document.querySelectorAll('.question-step');
    const totalSteps = steps.length;

    // Elements
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');

    const isFullPage = {{ 'true' if full_page_submission else 'false' }};

    function initQuiz() {
        if (totalSteps > 0) {
            if (!isFullPage) {
                showStep(0);
            } else {
                // In full page mode, hide progress bar
                if (document.querySelector('.w-full.bg-slate-200.rounded-full')) {
                    document.querySelector('.w-full.bg-slate-200.rounded-full').parentElement.style.display = 'none';
                }
                // Validate initially to disable submit button if empty
                validateAll();
            }
        } else {
            // Handle case with no questions
            alert('This quiz has no questions!');
        }
    }

    function showStep(index) {
        if (isFullPage) return;

        // Bounds check
        if (index < 0 || index >= totalSteps) return;

        // Hide all steps
        steps.forEach(step => step.classList.add('hidden'));

        // Show current step
        steps[index].classList.remove('hidden');

        // Update current index
        currentStep = index;

        // Update Progress
        const progress = ((index + 1) / totalSteps) * 100;
        progressBar.style.width = `${progress}%`;
        progressText.innerText = `Question ${index + 1} of ${totalSteps}`;
        progressPercent.innerText = `${Math.round(progress)}%`;

        // Update Buttons
        prevBtn.disabled = index === 0;

        if (index === totalSteps - 1) {
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
        } else {
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        }

        // Validate to enable/disable Next button
        validateCurrentStep();

        // Scroll to top of question container
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateAll() {
        let allValid = true;
        steps.forEach(step => {
            const inputs = step.querySelectorAll('input');
            let stepValid = false;
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) stepValid = true;
                } else if (input.type === 'text') {
                    if (input.value.trim() !== '') stepValid = true;
                }
            });
            if (!stepValid) allValid = false;
        });

        const submitButton = document.getElementById('submitBtn');
        if (submitButton) {
            submitButton.disabled = !allValid;
            if (allValid) {
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        return allValid;
    }

    function changeStep(n) {
        if (n === 1 && !validateCurrentStep()) {
            // Shake effect or alert could go here
            return;
        }
        showStep(currentStep + n);
    }

    function validateCurrentStep() {
        if (isFullPage) return validateAll();

        const currentStepEl = steps[currentStep];
        const inputs = currentStepEl.querySelectorAll('input');
        let isValid = false;

        inputs.forEach(input => {
            if (input.type === 'radio') {
                if (input.checked) isValid = true;
            } else if (input.type === 'text') {
                if (input.value.trim() !== '') isValid = true;
            }
        });

        const nextButton = document.getElementById('nextBtn');
        if (nextButton) nextButton.disabled = !isValid;

        // Also disable submit if on last step and invalid
        if (currentStep === totalSteps - 1) {
            const submitButton = document.getElementById('submitBtn');
            if (submitButton) submitButton.disabled = !isValid;
        }

        return isValid;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', initQuiz);

    // Add enter key support for text inputs
    document.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent default form submit
            if (!document.getElementById('nextBtn').disabled && !document.getElementById('nextBtn').classList.contains('hidden')) {
                changeStep(1);
            }
        }
    });

    // Prevent duplicate form submissions
    const quizForm = document.getElementById('quizForm');
    let isSubmitting = false;

    if (quizForm) {
        quizForm.addEventListener('submit', function (e) {
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
            isSubmitting = true;

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Submitting... <i class="fas fa-spinner fa-spin ml-2"></i>';
                submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
            }
        });
    }

</script>
{% endblock %}